# 実装計画

## 概要

本実装計画は、AI駆動型TRPGプラットフォームを段階的に構築するためのタスクリストです。Mastra AI フレームワークを中核とした効率的で拡張可能なアプローチに基づき、確実で実装可能なタスクに分解されています。

## マイルストーン構成

### マイルストーン1: Mastra AI統合とコアエンジン基盤 (期間: 2週間)
**目標**: Mastra AI フレームワークを導入し、エージェント・ワークフロー・RAGシステムを統合したコアエンジンを構築する

### マイルストーン2: MVP (Minimum Viable Product) 開発 (期間: 3週間)  
**目標**: プレイヤーが実際に遊べる最小限のWebアプリケーションを完成させる

### マイルストーン3: 機能拡張と永続化 (期間: 2週間)
**目標**: セーブ・ロード機能とシナリオ設定UIを実装し、継続的なプレイを可能にする

### マイルストーン4: ポリッシュとデプロイ (期間: 1週間)
**目標**: 品質向上と公開準備

## 実装タスク

### マイルストーン1: Mastra AI統合とコアエンジン基盤

#### フェーズ1: Mastra AI導入と統合（最優先・1週間）

- [ ] 1.1 Mastra AI フレームワーク導入
  - バックエンドプロジェクトへのMastra導入
  - 基本的なMastra設定とプロバイダー設定
  - OpenAI/Claude API統合の準備
  - 開発環境でのMastra動作確認
  - _要件: 6.1, 6.2_

- [ ] 1.2 GMエージェント設計・実装
  - Mastra エージェントの基本設計
  - TRPG GM用のシステムプロンプト作成
  - エージェントの初期化と設定機能
  - 基本的な対話機能の実装
  - _要件: 6.1, 6.2_

- [ ] 1.3 ゲーム専用ツール実装
  - rollDice ツール（判定システム）
  - updateStatusTags ツール（状態管理）
  - storeKnowledge ツール（知識蓄積）
  - 各ツールの統合テスト
  - _要件: 3.2, 3.3, 4.1, 4.2_

#### フェーズ2: RAGシステムとメモリ管理（並列実行可能）

- [ ] 2.1 RAGシステム実装
  - Vector Database設定（pgvector or Pinecone）
  - 埋め込み生成機能（OpenAI/Cohere）
  - 知識検索・取得機能
  - キャンペーン固有の知識管理
  - _要件: 1.2, 6.3, 6.4_

- [ ] 2.2 メモリ管理システム実装
  - エージェントメモリの永続化
  - 会話履歴の効率的な管理
  - セマンティック検索によるメモリ取得
  - メモリの重要度判定機能
  - _要件: 1.2, 1.4, 6.4_

- [ ] 2.3 データベース設計の完成
  - PostgreSQL完全スキーマ定義
  - Prisma ORMによるモデル定義
  - マイグレーションファイル作成
  - テストデータ作成スクリプト
  - _要件: 1.2, 1.4, 7.3_

#### フェーズ3: ワークフローとAPIエンドポイント

- [ ] 3.1 ゲームワークフロー実装
  - processGameAction ワークフローの設計
  - 段階的なゲーム処理（分析→判定→描写→更新）
  - エラーハンドリングとリトライ機能
  - ワークフローの統合テスト
  - _要件: 3.1, 3.2, 3.3, 3.5, 3.6_

- [ ] 3.2 キャンペーン作成API実装
  - POST /campaigns エンドポイントの実装
  - scenario_settings.json の処理ロジック
  - Mastra エージェントの初期化処理
  - 初期gameStateの生成とDB保存
  - _要件: 1.1, 2.1, 2.5_

- [ ] 3.3 プレイヤーアクション処理API実装
  - POST /campaigns/{campaignId}/action エンドポイントの実装
  - Mastra エージェント・ワークフローの実行
  - RAGシステムとの連携
  - 状態タグ変更の検知とgameState更新
  - _要件: 3.1, 3.2, 3.3, 3.5, 3.6, 4.1, 4.2_

- [ ] 3.4 キャンペーン状態取得API実装
  - GET /campaigns/{campaignId} エンドポイントの実装
  - gameStateの読み込みとレスポンス生成
  - エージェントメモリの取得
  - _要件: 1.3_

### マイルストーン2: MVP開発

#### 並列実行グループ2: フロントエンド・バックエンド統合（マイルストーン1完了後）

**Job A: フロントエンド基盤構築**
- [ ] 2A.1 フロントエンド状態管理システム実装
  - Zustand または Redux Toolkit による状態管理の導入
  - ゲーム状態、UI状態の管理構造定義
  - API通信用のサービス層実装
  - _要件: 5.1_

**Job B: バックエンドAPI統合テスト（並列実行可能）**
- [ ] 2B.1 API統合テスト実装
  - 各APIエンドポイントの単体テスト
  - AI統合部分のモックテスト
  - データベース操作のテスト
  - _要件: 3.1, 3.2, 3.3_

#### 並列実行グループ3: UIコンポーネント実装（状態管理完了後）

**Job A: コアゲームUIコンポーネント**
- [ ] 3A.1 チャットログコンポーネント実装
  - 会話履歴表示コンポーネントの作成
  - メッセージタイプ別スタイリング (player/gm/system)
  - 自動スクロール機能の実装
  - _要件: 5.1, 5.4_

- [ ] 3A.2 アクション入力コンポーネント実装
  - 自然言語入力フォームの作成
  - 送信状態管理とローディング表示
  - エンターキー送信とバリデーション
  - _要件: 3.1, 5.3_

**Job B: 状態表示UIコンポーネント（並列実行可能）**
- [ ] 3B.1 状態表示コンポーネント実装
  - 現在のstatusTagsとinventoryを表示するサイドバー
  - タグの視覚的表示とツールチップ機能
  - リアルタイム状態更新の反映
  - _要件: 4.3, 5.2_

- [ ] 3B.2 判定結果表示コンポーネント実装
  - ダイスロール結果（目標値、出目、理由）の表示
  - 成功/失敗の視覚的フィードバック
  - 判定理由の詳細表示
  - _要件: 3.3, 3.4_

**Job C: WebSocket統合（並列実行可能）**
- [ ] 3C.1 リアルタイム通信実装
  - Socket.io によるWebSocket統合
  - リアルタイム状態同期
  - 接続状態管理とエラーハンドリング
  - _要件: 7.1_

#### 統合フェーズ: ゲームフロー統合（全UIコンポーネント完了後）

- [ ] 4.1 キャンペーン開始フロー実装
  - アプリケーション起動時の新規キャンペーン作成
  - POST /campaigns API呼び出しとレスポンス処理
  - 初期状態のUI反映
  - _要件: 1.1, 2.5_

- [ ] 4.2 ゲームプレイフロー実装
  - アクション入力からAPI呼び出しまでの完全なフロー
  - POST /campaigns/{campaignId}/action の統合
  - レスポンスデータによるUI更新（narrative, gameState）
  - エラーハンドリングとユーザーフィードバック
  - _要件: 3.1, 3.2, 3.5, 3.6_

### マイルストーン3: 機能拡張と永続化

#### 7. ユーザー管理とキャンペーン永続化

- [ ] 7.1 基本認証システム実装
  - JWT ベースの認証システム構築
  - ログイン/サインアップページの作成
  - 認証ミドルウェアの実装
  - _要件: 7.2_

- [ ] 7.2 キャンペーン管理機能拡張
  - ユーザーごとのキャンペーン管理機能
  - データベーススキーマの拡張
  - GET /campaigns エンドポイントの実装（キャンペーン一覧）
  - _要件: 1.1, 1.3_

- [ ] 7.3 キャンペーン一覧・再開機能実装
  - 過去のキャンペーン一覧表示ダッシュボード
  - キャンペーン選択と再開機能
  - GET /campaigns/{campaignId} を使用した状態復元
  - _要件: 1.3_

#### 8. シナリオ設定UI実装

- [ ] 8.1 シナリオ設定フォーム実装
  - scenario_settings.json の各項目に対応するWebフォーム
  - GM人格、世界観、物語導入部の入力UI
  - フォームバリデーションとプレビュー機能
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 8.2 新規キャンペーン作成フロー統合
  - シナリオ設定フォームからキャンペーン作成までの完全なフロー
  - POST /campaigns への設定データ送信
  - 作成されたキャンペーンへの自動遷移
  - _要件: 1.1, 2.5_

### マイルストーン4: ポリッシュとデプロイ

#### 9. 品質向上とエラーハンドリング

- [ ] 9.1 包括的エラーハンドリング実装
  - APIエラー、Inworld接続エラーの適切な処理
  - ユーザーフレンドリーなエラーメッセージ表示
  - 自動リトライとフォールバック機能
  - _要件: 6.2, 6.3, 7.1_

- [ ] 9.2 UI/UX改善とレスポンシブ対応
  - 全体的なデザインの洗練
  - モバイル・タブレット対応
  - アクセシビリティ改善
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 9.3 パフォーマンス最適化
  - API応答時間の最適化
  - フロントエンドの読み込み速度改善
  - メモリ使用量の最適化
  - _要件: 7.1_

#### 10. デプロイメント準備

- [ ] 10.1 フロントエンドデプロイ設定
  - Vercel または Netlify へのデプロイ設定
  - 環境変数の適切な管理
  - ビルド最適化とCDN設定
  - _要件: 7.2_

- [ ] 10.2 バックエンドデプロイ設定
  - Render または Fly.io へのデプロイ用Dockerfile作成
  - 環境変数とシークレット管理
  - データベース接続とマイグレーション設定
  - _要件: 7.2, 7.3_

- [ ] 10.3 最終テストと品質保証
  - エンドツーエンドテストの実施
  - 本番環境での動作確認
  - セキュリティチェックとパフォーマンステスト
  - _要件: 7.1, 7.3, 7.4_